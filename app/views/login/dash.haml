- require 'json'

//*****tables for each user
//**************************
%table.table-expand.ui-widget
  %thead
    %tr.bold 
      %td.ui-widget-header
        = link_to "PERCOLAIT TRACKER.", dash_url
  %tbody
    %tr
      %td.ui-widget.ui-widget-content.ui-corner-top
        %table
          %thead
            %tr.bold
              %td

          %tbody
            %tr
              - session[:token] = session[:user].token
              - return_val = Login.labelled(session[:token])
              - @project_xmls = return_val[0]
              - @labels = return_val[1]
              - @project_stories = return_val[2]
              - x_arr = []
              - @labels.each do |label|
                %td.valign
                  %p.ui-widget-header.ui-corner-all.label
                    = label
                  %table.collapse
                    %tbody
                      - i=0
                      - @project_xmls.each do |x|
                        - x_arr << x.at('id').innerHTML
                        %li.dashed= x.at('name').innerHTML
                        %ul{:class => "#{x.at('id').innerHTML} sortable movable connectedSortable_#{x.at('id').innerHTML}"}
                          - stories = @project_stories[i]
                          - i+=1
                          - s = Login.find_labels(stories,label)
                          - s.each do |a|
                            - if a.at('story_type').innerHTML == "release"
                              %li{:class => 'milestone state-disabled cursor-default center'}
                                = a.at('name').innerHTML
                            -else
                              %li.ui-state-default
                                %div.icons
                                  %img{:src => "images/move.png", :class => "corner"}
                                  -if ( a.at('estimate')  and a.at('estimate').innerHTML != "-1")
                                    %img{:src=>"http://www.pivotaltracker.com/images/v3/icons/stories_view/estimate_#{a.at('estimate').innerHTML}pt_linear.gif", :class =>"estimateIcon" }
                                  %img{:src=>"http://www.pivotaltracker.com/images/v3/icons/stories_view/#{a.at('story_type').innerHTML}_icon.png", :class =>"storyTypeIcon" }
                                = a.at('name').innerHTML
%br
    
:javascript
  var myVar = new Array(#{x_arr.size});
  myVar = #{x_arr.to_json};
  
  $(document).ready(function(index){
    $(myVar).each(function(index, obj){
      $("." + this).sortable({
        connectWith: ".connectedSortable_" + this,
        cancel: '.state-disabled',
      }).disableSelection();
    });
  });
